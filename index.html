<!doctype html> 
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Part-2 (Manager) ‚Äî Technician Assign</title>
<style>
  body{margin:0;font-family:Arial;background:#000000;color:#111}
  .wrap{max-width:980px;margin:auto;padding:18px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  h2,h3{margin:0 0 10px;color:#111}
  label{font-size:12px;opacity:.85;display:block;margin:10px 0 6px}
  input,select,textarea,button{
    width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;
    background:#fff;color:#111;outline:none;box-sizing:border-box}
  input:focus,select:focus,textarea:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:750px){.row{grid-template-columns:1fr}}
  button{background:#2563eb;color:#fff;font-weight:bold;cursor:pointer;border:none;margin-top:12px}
  button:disabled{opacity:.6;cursor:not-allowed}
  .btn2{background:#f3f4f6;color:#111;border:1px solid #d1d5db;margin-top:8px}
  .hint{font-size:12px;color:#374151;margin-top:6px;line-height:1.4}
  .box2{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;padding:10px;margin-top:10px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .box2 pre{white-space:pre-wrap;margin:0}

  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .actions button{width:auto;padding:10px 12px;margin-top:0}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
  .box{width:min(520px,100%);background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
  .box h3{margin:0 0 8px;color:#111}
  .box pre{white-space:pre-wrap;background:#f3f4f6;border:1px solid #e5e7eb;padding:10px;border-radius:12px;margin:10px 0;color:#111}
.logo-wrap{display:flex;justify-content:center;margin:6px 0 10px}
.logo-wrap img{max-width:160px;width:100%;height:auto;display:block}
#btnLogin{background:#f6c10a;color:#0b2540}
#btnLogin:disabled{opacity:.6}
#btnAssign{background:#f6c10a;color:#0b2540}
#btnAssign:disabled{opacity:.6}


</style>
</head>
<body>

<div class="wrap">
  <div class="logo-wrap" id="topLogo">
    <img src="toplogo.png" alt="Logo">
  </div>

  <h2>Manager Panel ‚Äî Technician Assign</h2>

  <div class="card" id="mainCard" style="display:none">
    <div class="row">
      <div>
        <label>Booking ID</label>
        <select id="bookingId"></select>
        <div class="actions">
          <button class="btn2" type="button" id="btnReload">üîÑ Reload</button>
          <button class="btn2" type="button" id="btnDetails">üìÑ Load Details</button>
          <button class="btn2" type="button" id="btnLogout">üö™ Logout</button>
        </div>
        <div class="hint" id="teamHint"></div>
      </div>

      <div>
        <label>Technician</label>
        <select id="techName" disabled>
          <option value="">-- Select booking first --</option>
        </select>
        <div class="hint"></div>
      </div>
    </div>

    <label>Manager Note (optional)</label>
    <textarea id="adminNote" placeholder="Any note for technician..."></textarea>

    <button id="btnAssign" disabled>‚úÖ Assign Technician</button>

    <div class="box2" id="detailsBox" style="display:none">
      <div><b>Booking Details</b></div>
      <pre class="mono" id="detailsText"></pre>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div class="modal" id="loginModal">
  <div class="box">
    <div class="logo-wrap" style="margin-top:0">
      <img src="logo.png" alt="Logo">
    </div>
    <h3>Manager Login</h3>
    <label>User ID</label>
    <input id="u" placeholder="e.g. team01">
    <label>Password</label>
    <input id="p" type="password" placeholder="Password">
    <button id="btnLogin">Login</button>
    <div class="hint" id="loginHint"></div>
  </div>
</div>

<!-- MESSAGE MODAL -->
<div class="modal" id="modal" onclick="if(event.target.id==='modal')closeModal()">
  <div class="box">
    <h3 id="mt">Message</h3>
    <pre id="mb"></pre>

    <div class="actions" id="resultActions" style="display:none">
      <button class="btn2" type="button" id="copyCust">üìã Copy Customer Msg</button>
      <button class="btn2" type="button" id="copyTech">üìã Copy Technician Msg</button>
      <button class="btn2" type="button" id="openCustWA">üü¢ Open Customer WhatsApp</button>
      <button class="btn2" type="button" id="openTechWA">üü¢ Open Technician WhatsApp</button>
    </div>

    <button onclick="closeModal()">OK</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycby6J1PUZdgXAh-T7GVN5SJtw3lM_JeFUyDtj6Zk71ppOik-4wTkqW6zFyswwagNRs76UQ/exec";

const $ = (id)=>document.getElementById(id);
function openModal(title, body){
  $("mt").textContent = title;
  $("mb").textContent = body;
  $("modal").style.display="flex";
}
function closeModal(){
  $("modal").style.display="none";
  $("resultActions").style.display="none";
}

async function postJSON(payload){
  const res = await fetch(API_URL, {
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify(payload)
  });
  const txt = await res.text();
  try{ return JSON.parse(txt); }catch(e){ throw new Error("Non-JSON:\n"+txt.slice(0,250)); }
}

async function getJSON(url){
  const res = await fetch(url, { method:"GET" });
  const txt = await res.text();
  try{ return JSON.parse(txt); }catch(e){ throw new Error("Non-JSON:\n"+txt.slice(0,250)); }
}

function setBookingOptions(items){
  const sel = $("bookingId");
  sel.innerHTML = "";
  if(!items || !items.length){
    sel.innerHTML = `<option value="">-- No NEW bookings for your team --</option>`;
    return;
  }
  sel.innerHTML = `<option value="">-- Select Booking ID --</option>` +
    items.map(x=>`<option value="${x.bookingId}">${x.bookingId} (${x.status})</option>`).join("");
}

let TOKEN = sessionStorage.getItem("mgr_token") || "";
let TEAMID = sessionStorage.getItem("mgr_team") || "";

let cachedDetails = null;
let techList = [];
let lastLinks = { custWA:"", techWA:"", custText:"", techText:"" };

function showLogin(){
  $("loginModal").style.display="flex";
  $("mainCard").style.display="none";
const tl = document.getElementById("topLogo"); if(tl) tl.style.display="none";
}
function showMain(){
  $("loginModal").style.display="none";
  $("mainCard").style.display="block"; const tl = document.getElementById("topLogo"); if(tl) tl.style.display="flex";
}

$("btnLogin").onclick = async ()=>{
  try{
    $("btnLogin").disabled = true;
    $("loginHint").textContent = "Logging in...";
    const out = await postJSON({ action:"login", username:$("u").value.trim(), password:$("p").value.trim() });
    if(!out || !out.ok) throw new Error(out?.error || "Login failed");

    TOKEN = out.token;
    TEAMID = out.teamId;
    sessionStorage.setItem("mgr_token", TOKEN);
    sessionStorage.setItem("mgr_team", TEAMID);

    $("loginHint").textContent = "";
    showMain();

    await loadTechListFast();
    await loadBookingList();
  }catch(e){
    $("loginHint").textContent = String(e);
  }finally{
    $("btnLogin").disabled = false;
  }
};

$("btnLogout").onclick = ()=>{
  sessionStorage.removeItem("mgr_token");
  sessionStorage.removeItem("mgr_team");
  TOKEN=""; TEAMID="";
  showLogin();
};

async function loadTechListFast(){
  const out = await postJSON({ action:"techListByTeam", token: TOKEN });
  if(!out || !out.ok) throw new Error(out?.error || "Tech list failed");
  techList = (out.techs || []).map(x=>x.name);
}

async function loadBookingList(){
  $("btnAssign").disabled = true;
  $("techName").disabled = true;
  $("techName").innerHTML = `<option value="">-- Select booking first --</option>`;
  $("detailsBox").style.display="none";
  cachedDetails = null;

  const out = await postJSON({ action:"listTeam", token: TOKEN, statuses:"NEW,SCHEDULED" });
  if(!out || !out.ok) throw new Error(out?.error || "List failed");

  $("teamHint").textContent = `Logged in Team: ${out.teamId}`;
  setBookingOptions(out.items || []);
}

async function loadDetails(){
  const bid = $("bookingId").value.trim();
  if(!bid){ openModal("‚ùå Error","Please select Booking ID"); return; }

  const out = await getJSON(API_URL + `?action=details&bookingId=${encodeURIComponent(bid)}`);
  if(!out || !out.ok) throw new Error(out?.error || "Details failed");
  cachedDetails = out.booking;

  $("detailsText").textContent = [
    `BookingID: ${cachedDetails.BookingID||""}`,
    `Service: ${cachedDetails.Service||""}`,
    `Date/Slot: ${cachedDetails.Date||""} | ${cachedDetails.Slot||""}`,
    `Customer: ${cachedDetails.Name||""}`,
    `Phone: ${cachedDetails.Phone||""}`,
    `Email: ${cachedDetails.Email||""}`,
    `Address: ${cachedDetails.Address||""}`,
    `Pincode: ${cachedDetails.Pincode||""}`,
    `Location: ${cachedDetails.LocationLink||""}`,
    `Problem: ${cachedDetails.Problem||""}`,
    `Team: ${cachedDetails.TeamName||""} (${cachedDetails.TeamId||""})`
  ].join("\n");

  $("detailsBox").style.display="block";

  // tech dropdown (fast: already have team list)
  $("techName").innerHTML = `<option value="">-- Select Technician --</option>` +
    techList.map(n=>`<option value="${n}">${n}</option>`).join("");
  $("techName").disabled = false;

  updateAssignBtn();
}

function updateAssignBtn(){
  const ok = $("bookingId").value.trim() && $("techName").value.trim();
  $("btnAssign").disabled = !ok;
}

function copyToClipboard(text){
  navigator.clipboard.writeText(text).then(()=>{
    openModal("‚úÖ Copied","Message copied to clipboard.");
  }).catch(()=>{
    openModal("‚ùå Copy Failed","Manually copy karo.");
  });
}

$("btnReload").onclick = ()=>{
  if(__loadTimer) clearTimeout(__loadTimer);
  loadList().catch(()=>{});
setTimeout(()=>{
  (items.slice(0,10)||[]).forEach(it=>{
    const bid = it.bookingId;
    if(!bid || DETAILS_CACHE[bid]) return;
    postJSON({ action:"adminDetails", token:TOKEN, bookingId:bid })
      .then(out=>{
        if(out && out.ok) DETAILS_CACHE[bid] = out.booking || {};
      })
      .catch(()=>{});
  });
},200);
};
$("btnDetails").onclick = async ()=>{
  try{ $("btnDetails").disabled = true; await loadDetails(); }
  catch(e){ openModal("‚ùå Error", String(e)); }
  finally{ $("btnDetails").disabled = false; }
};

$("bookingId").addEventListener("change", ()=>{
  $("detailsBox").style.display="none";
  cachedDetails=null;
  $("techName").disabled=true;
  $("techName").innerHTML=`<option value="">-- Select booking first --</option>`;
  updateAssignBtn();
});
$("techName").addEventListener("change", updateAssignBtn);

$("btnAssign").onclick = async ()=>{
  try{
    const bid = $("bookingId").value.trim();
    const techName = $("techName").value.trim();
    if(!bid || !techName) return;

    $("btnAssign").disabled = true;

    const out = await postJSON({
      action:"assign",
      token: TOKEN,               // ‚úÖ auth
      bookingId: bid,
      technicianName: techName,
      adminNote: $("adminNote").value.trim()
    });

    if(!out || !out.ok) throw new Error(out?.error || "Assign failed");

    lastLinks.custWA = out.waLinkCustomer || "";
    lastLinks.techWA = out.waLinkTech || "";
    lastLinks.custText = out.waTextCustomer || "";
    lastLinks.techText = out.waTextTech || "";

    let msg = `Assigned ‚úÖ\nBookingID: ${bid}\nTechnician: ${out.assignedTo} (${out.assignedPhone})`;
    msg += `\n\nCustomer WhatsApp Text:\n${lastLinks.custText || "-"}`;
    msg += `\n\nTechnician WhatsApp/SMS Text:\n${lastLinks.techText || "-"}`;

    openModal("‚úÖ Assigned", msg);
    $("resultActions").style.display="flex";

    $("copyCust").onclick = ()=>copyToClipboard(lastLinks.custText || "");
    $("copyTech").onclick = ()=>copyToClipboard(lastLinks.techText || "");
    $("openCustWA").onclick = ()=>{ if(lastLinks.custWA) window.open(lastLinks.custWA,"_blank"); else openModal("‚ùå","Customer WhatsApp link blank"); };
    $("openTechWA").onclick = ()=>{ if(lastLinks.techWA) window.open(lastLinks.techWA,"_blank"); else openModal("‚ùå","Technician WhatsApp link blank"); };

    $("adminNote").value="";
    await loadBookingList();
  }catch(e){
    openModal("‚ùå Error", String(e));
    updateAssignBtn();
  }
};

(function init(){
  if(TOKEN && TEAMID){
    showMain();
    loadTechListFast().then(loadBookingList).catch(()=>{
      // token expired
      showLogin();
    });
  }else{
    showLogin();
  }
})();
</script>
</body>
</html>
